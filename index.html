<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AegisCrypt (Simplificado)</title>
    <style>
        :root { --bg:#0f1222; --card:#161a2f; --muted:#8a93b2; --text:#e6e9f5; --accent:#7aa2ff; --accent-2:#64d2ff; --danger:#ff6b6b; --ok:#58d68d; --radius:16px; }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background: radial-gradient(1200px 800px at 20% -10%, #1a1f3f 0%, transparent 60%), radial-gradient(1000px 700px at 120% 10%, #11243c 0%, transparent 60%), var(--bg); color: var(--text); }
        .container { max-width: 1000px; margin: 40px auto; padding: 0 16px; }
        .header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        h1 { margin: 0; font-size: 28px; }
        .badge { font-size: 12px; color: var(--accent-2); background: rgba(100, 210, 255, .1); padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(100, 210, 255, .2); }
        .grid { display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 18px; }
        @media(min-width: 920px) { .grid { grid-template-columns: 1fr 1fr; } }
        .card { background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, 0)); border: 1px solid rgba(255, 255, 255, .08); border-radius: var(--radius); padding: 16px; backdrop-filter: blur(6px); box-shadow: 0 10px 30px rgba(0, 0, 0, .3); }
        .card h2 { margin: 0 0 8px; font-size: 18px; color: #dfe7ff; }
        .sub { color: var(--muted); font-size: 13px; margin-top: 4px; }
        textarea, input[type=password], input[type=text] { width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, .08); background: #0e1327; color: var(--text); resize: vertical; min-height: 120px; outline: none; }
        input[type=password], input[type=text] { min-height: auto; }
        textarea:focus, input:focus { border-color: rgba(122, 162, 255, .5); box-shadow: 0 0 0 3px rgba(122, 162, 255, .15); }
        .row { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { border: 1px solid rgba(255, 255, 255, .12); background: linear-gradient(180deg, rgba(122, 162, 255, .18), rgba(122, 162, 255, .08)); color: var(--text); padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; transition: transform .06s ease, filter .2s ease; }
        .btn:hover { filter: brightness(1.08); }
        .btn:active { transform: translateY(1px); }
        .btn.secondary { background: transparent; }
        .btn.danger { background: linear-gradient(180deg, rgba(255, 107, 107, .18), rgba(255, 107, 107, .08)); border-color: rgba(255, 107, 107, .35); }
        .hint { font-size: 12px; color: var(--muted); margin-top: 8px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
        .out { min-height: 160px; background: #0b1022; }
        .footer { margin-top: 22px; font-size: 12px; color: var(--muted); }
        .status { margin-top: 10px; font-size: 13px; }
        .ok { color: var(--ok); }
        .err { color: var(--danger); }
        .file { display: inline-block; padding: 9px 12px; border: 1px dashed rgba(255, 255, 255, .25); border-radius: 10px; cursor: pointer; }
        input[type=file] { display: none; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>AegisCrypt</h1>
        <span class="badge">AES‑256‑GCM • PBKDF2‑SHA‑256 • WebCrypto</span>
    </div>

    <div class="grid">
        <div class="card">
            <h2>Entrada</h2>
            <div class="sub">Digite o texto a ser <strong>criptografado</strong> ou cole o JSON para <strong>descriptografar</strong>.</div>
            <textarea id="input" placeholder="Seu texto aqui..."></textarea>

            <div class="row" style="margin-top:10px;align-items:center;">
                <input id="password" type="password" placeholder="Senha" />
                <button class="btn secondary" id="genPass">Gerar senha</button>
            </div>

            <div class="hint">A senha será usada para criptografar ou descriptografar a mensagem.</div>

            <div class="row" style="margin-top:12px;">
                <button class="btn" id="encryptBtn">Criptografar</button>
                <button class="btn" id="decryptBtn">Descriptografar</button>
                <button class="btn secondary" id="clearBtn">Limpar</button>
            </div>

            <div class="status" id="status"></div>
        </div>

        <div class="card">
            <h2>Saída</h2>
            <div class="sub">Copie o resultado ou baixe como arquivo .enc.</div>
            <textarea id="output" class="out mono" placeholder="Saída aparecerá aqui..." readonly></textarea>

            <div class="row" style="margin-top:12px;">
                <button class="btn" id="copyBtn">Copiar</button>
                <label for="fileIn" class="file">Carregar arquivo para descriptografia</label>
                <input id="fileIn" type="file" accept=".enc,application/json,text/plain" />
                <button class="btn" id="downloadBtn">Baixar .enc</button>
            </div>
            <div class="hint mono" id="meta"></div>
        </div>
    </div>

    <div class="card" style="margin-top:16px;">
        <h2>Como funciona</h2>
        <div class="sub">
            <ul>
                <li>Você fornece a senha → derivamos uma chave com <b>PBKDF2‑SHA‑256</b> (salt de 128 bits, ≥600k iterações) → ciframos com <b>AES‑GCM‑256</b>.</li>
            </ul>
        </div>
        <div class="hint">AES‑256‑GCM é um padrão moderno de criptografia, considerado "nível militar" quando bem aplicado. O app roda 100% no seu navegador, sem enviar dados para servidores.</div>
    </div>

    <div class="footer">
        Desenvolvido por Eder Prioli
    </div>
</div>

<script>
// ====================================================================
// ============ INÍCIO DO CÓDIGO SIMPLIFICADO =========================
// ====================================================================

// Funções utilitárias e parâmetros
const $ = (s) => document.querySelector(s);
const enc = new TextEncoder();
const dec = new TextDecoder();
const b64e = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
const b64d = (b64) => Uint8Array.from(atob(b64), (c) => c.charCodeAt(0));
const rand = (n) => { const b = new Uint8Array(n); crypto.getRandomValues(b); return b; };

const CRYPTO_PARAMS = {
    version: 1,
    kdf: 'PBKDF2-SHA256',
    iterations: 600_000,
    saltBytes: 16,
    nonceBytes: 12,
    keyLen: 256,
};

// Funções criptográficas
async function deriveKeyFromPassword(password, salt) {
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), { name: 'PBKDF2' }, false, ['deriveKey']);
    return crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt, iterations: CRYPTO_PARAMS.iterations, hash: 'SHA-256' },
        keyMaterial,
        { name: 'AES-GCM', length: CRYPTO_PARAMS.keyLen },
        false,
        ['encrypt', 'decrypt']
    );
}

function genReadablePassword(len = 22) {
    const alphabet = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_@#%*+';
    const arr = rand(len);
    let out = '';
    for (const b of arr) {
        out += alphabet[b % alphabet.length];
    }
    return out;
}

// Funções de manipulação da interface e eventos
const UI = {
    showStatus(message, isError = false) {
        $('#status').innerHTML = `<span class="${isError ? 'err' : 'ok'}">${message}</span>`;
    },

    showMetadata(obj) {
        const size = obj?.ct ? b64d(obj.ct).length : 0;
        $('#meta').textContent = `ct=${size} bytes • it=${obj.it}`;
    },

    async handleEncrypt() {
        try {
            const text = $('#input').value;
            const password = $('#password').value;
            if (!text || !password) throw new Error('Digite um texto e uma senha.');
            
            UI.showStatus('Criptografando…');
            
            const salt = rand(CRYPTO_PARAMS.saltBytes);
            const key = await deriveKeyFromPassword(password, salt);
            const nonce = rand(CRYPTO_PARAMS.nonceBytes);
            const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: nonce }, key, enc.encode(text));
            
            const result = {
                v: CRYPTO_PARAMS.version,
                a: 'AES-256-GCM',
                kdf: CRYPTO_PARAMS.kdf,
                it: CRYPTO_PARAMS.iterations,
                salt: b64e(salt),
                nonce: b64e(nonce),
                ct: b64e(ct)
            };
            
            $('#output').value = JSON.stringify(result, null, 2);
            UI.showMetadata(result);
            UI.showStatus('OK: conteúdo cifrado.');
        } catch (e) {
            UI.showStatus(`Erro: ${e.message}`, true);
        }
    },

    async handleDecrypt() {
        try {
            const raw = $('#input').value || $('#output').value;
            const password = $('#password').value;
            if (!raw) throw new Error('Cole o JSON cifrado.');
            if (!password) throw new Error('Insira a senha usada para criptografar.');
            
            UI.showStatus('Descriptografando…');
            
            const obj = JSON.parse(raw);
            const salt = b64d(obj.salt);
            const nonce = b64d(obj.nonce);
            const ct = b64d(obj.ct);
            const key = await deriveKeyFromPassword(password, salt);
            const pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: nonce }, key, ct);
            
            $('#output').value = dec.decode(pt);
            $('#meta').textContent = 'OK';
            UI.showStatus('OK: autenticação GCM verificada. Mensagem descriptografada.');
        } catch (e) {
            const msg = (/Operation failed|data/.test(e?.message||'')) ? 'Falha de autenticação (senha incorreta) ou dados corrompidos.' : e.message;
            UI.showStatus(`Erro: ${msg}`, true);
        }
    },

    handleClear() {
        $('#input').value = '';
        $('#output').value = '';
        $('#password').value = '';
        UI.showStatus('');
        $('#meta').textContent = '';
    },

    handleCopy() {
        const value = $('#output').value.trim();
        if (!value) return;
        navigator.clipboard.writeText(value);
        UI.showStatus('Copiado.');
    },

    handleDownload() {
        const value = $('#output').value.trim();
        if (!value) return;
        const blob = new Blob([value], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'mensagem.enc.json';
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    },

    handleGenPassword() {
        $('#password').value = genReadablePassword();
    },

    handleFileLoad(e) {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            $('#input').value = event.target.result;
            UI.showStatus('Arquivo carregado. Agora, insira a senha usada na criptografia e clique em "Descriptografar".');
        };
        reader.readAsText(file);
    },

    init() {
        $('#encryptBtn').addEventListener('click', this.handleEncrypt);
        $('#decryptBtn').addEventListener('click', this.handleDecrypt);
        $('#clearBtn').addEventListener('click', this.handleClear);
        $('#copyBtn').addEventListener('click', this.handleCopy);
        $('#downloadBtn').addEventListener('click', this.handleDownload);
        $('#genPass').addEventListener('click', this.handleGenPassword);
        $('#fileIn').addEventListener('change', this.handleFileLoad);
    }
};

// Inicia o aplicativo
document.addEventListener('DOMContentLoaded', () => UI.init());
</script>
</body>
</html>
